app.post('/api/videos/generate', asyncHandler(async (req, res) => {
  const {
    prompt,
    model,
    aspectRatio,
    resolution,
    duration,
    userId,
    optimizePrompt = true,
    generateAudio
  } = req.body;
  const { negativePrompt, seed, personGeneration, image, mock } = req.body;

  // Generate unique request ID
  const requestId = `req_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

  console.log(`\n${'*'.repeat(80)}`);
  console.log(`[SERVER ${requestId}] üì• VIDEO GENERATION REQUEST RECEIVED`);
  console.log(`${'*'.repeat(80)}`);
  console.log(`[SERVER ${requestId}] User: ${userId || 'anonymous'}`);
  console.log(`[SERVER ${requestId}] Model: ${model}`);
  console.log(`[SERVER ${requestId}] Duration: ${duration}s`);
  console.log(`[SERVER ${requestId}] Resolution: ${resolution}`);
  console.log(`[SERVER ${requestId}] Aspect Ratio: ${aspectRatio}`);
  console.log(`[SERVER ${requestId}] Prompt length: ${prompt?.length || 0} chars`);
  console.log(`${'*'.repeat(80)}\n`);

  // Optimize prompt if requested
  let finalPrompt = prompt;
  let promptMetadata = null;

  if (optimizePrompt && prompt) {
    console.log(`[SERVER ${requestId}] üîß Optimizing prompt...`);
    const optimized = promptOptimizer.optimize(prompt, {
      enhanceVisuals: true,
      addTradingContext: true,
      ensureCompliance: true,
      targetLength: 'optimal'
    });
    finalPrompt = optimized.optimized;
    promptMetadata = optimized.metadata;

    console.log(`[SERVER ${requestId}] ‚úÖ Prompt optimized: ${prompt.length} ‚Üí ${finalPrompt.length} chars`);
    console.log(`[SERVER ${requestId}] Compliance issues fixed: ${promptMetadata.complianceIssuesFixed}`);
  }

  try {
    // Start generation (will return immediately, video generates async)
    console.log(`[SERVER ${requestId}] üöÄ Forwarding to Veo3Service...`);
    const result = await veo3Service.generateVideo({
      prompt: finalPrompt,
      model,
      aspectRatio,
      resolution,
      duration,
      generateAudio,
      mock,
      negativePrompt,
      seed,
      personGeneration,
      image,
      userId: userId || 'anonymous',
      requestId
    });

    const downloaded = await veo3Service.downloadVideoAsset(result.video?.url, requestId);

    await videoStore.addVideo({
      id: result.requestId,
      title: (finalPrompt || prompt || 'Trading Bot Demo').slice(0, 80),
      thumbnail: downloaded?.thumbnailPath || 'https://images.unsplash.com/photo-1520607162513-77705c0f0d4a?auto=format&fit=crop&w=800&q=80',
      sourceUrl: result.video?.url || '',
      localPath: downloaded?.localPath,
      publicPath: downloaded?.publicPath,
      thumbnailPath: downloaded?.thumbnailPath,
      duration: duration || 8,
      model,
      category: 'studio',
      createdAt: new Date().toISOString(),
      views: 0,
      userId: userId || 'anonymous'
    });

    // Add prompt optimization metadata to response
    if (promptMetadata) {
      result.promptOptimization = {
        original: prompt,
        optimized: finalPrompt,
        ...promptMetadata
      };
    }

    console.log(`[SERVER ${requestId}] ‚úÖ Returning success response to client`);
    console.log(`[SERVER ${requestId}] Video URL: ${result.video.url}\n`);

    res.status(202).json({
      success: true,
      message: 'Video generation completed',
      data: result
    });
  } catch (error) {
    console.error(`[SERVER ${requestId}] ‚ùå Generation failed in server handler`);
    console.error(`[SERVER ${requestId}] Error:`, error.message);
    throw error; // Let error handler middleware catch it
  }
}));

/**
 * @route   POST /api/videos/estimate-cost
 * @desc    Estimate cost for video generation
 * @access  Public
 */
